# .github/workflows/latex_resume.yml
name: Build Japanese LaTeX Resume
on:
  push:            # ← どのブランチでも発火
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Compile 職務経歴書 (LuaLaTeX)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show tree (top)
        run: |
          pwd && ls -la
          echo "---- recursive ----"
          ls -R | head -n 300

      # Aパス: repo/samizo-aitl-resume/main_resume.tex がある場合だけ実行
      - name: Compile (A= samizo-aitl-resume)
        if: ${{ hashFiles('samizo-aitl-resume/main_resume.tex') != '' }}
        uses: xu-cheng/latex-action@v3
        with:
          working_directory: samizo-aitl-resume
          root_file: main_resume.tex
          latexmk_use_lualatex: true
        continue-on-error: true

      # Bパス: repo/latex-papers/samizo-aitl-resume/main_resume.tex がある場合だけ実行
      - name: Compile (B= latex-papers/samizo-aitl-resume)
        if: ${{ hashFiles('latex-papers/samizo-aitl-resume/main_resume.tex') != '' }}
        uses: xu-cheng/latex-action@v3
        with:
          working_directory: latex-papers/samizo-aitl-resume
          root_file: main_resume.tex
          latexmk_use_lualatex: true
        continue-on-error: true

      # A/B いずれかで失敗した時にログ末尾を出す
      - name: Tail logs on failure (A)
        if: failure() && hashFiles('samizo-aitl-resume/main_resume.log') != ''
        run: |
          echo "==== tail samizo-aitl-resume/main_resume.log ===="
          tail -n 200 samizo-aitl-resume/main_resume.log || true
      - name: Tail logs on failure (B)
        if: failure() && hashFiles('latex-papers/samizo-aitl-resume/main_resume.log') != ''
        run: |
          echo "==== tail latex-papers/samizo-aitl-resume/main_resume.log ===="
          tail -n 200 latex-papers/samizo-aitl-resume/main_resume.log || true

      # PDF を常にアップロード（A/B両方拾う）
      - name: Upload PDF artifact(s)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main_resume_pdf
          path: |
            samizo-aitl-resume/main_resume.pdf
            latex-papers/samizo-aitl-resume/main_resume.pdf
          if-no-files-found: ignore

      # 生成ログ・中間ファイルを常にアップロード（A/B両方）
      - name: Upload all LaTeX logs & intermediates
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latex_logs
          path: |
            samizo-aitl-resume/*.log
            samizo-aitl-resume/*.aux
            samizo-aitl-resume/*.fls
            samizo-aitl-resume/*.fdb_latexmk
            samizo-aitl-resume/*.synctex.gz
            samizo-aitl-resume/*.toc
            samizo-aitl-resume/*.out
            latex-papers/samizo-aitl-resume/*.log
            latex-papers/samizo-aitl-resume/*.aux
            latex-papers/samizo-aitl-resume/*.fls
            latex-papers/samizo-aitl-resume/*.fdb_latexmk
            latex-papers/samizo-aitl-resume/*.synctex.gz
            latex-papers/samizo-aitl-resume/*.toc
            latex-papers/samizo-aitl-resume/*.out
          if-no-files-found: warn
