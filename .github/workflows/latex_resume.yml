# .github/workflows/latex_resume.yml
name: Build Japanese LaTeX Resume

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Compile 職務経歴書 (LuaLaTeX)

    steps:
      # 1) 取得
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) TeX Live (full) — 日本語・luatexja・HaranoAji まで全部入る
      - name: Install TeX Live (full)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y texlive-full latexmk

      # 3) どこに main_resume.tex があるか検出（A/BどちらでもOK）
      - name: Detect resume directory
        id: detect
        shell: bash
        run: |
          if [ -f samizo-aitl-resume/main_resume.tex ]; then
            echo "dir=samizo-aitl-resume" >> "$GITHUB_OUTPUT"
          elif [ -f latex-papers/samizo-aitl-resume/main_resume.tex ]; then
            echo "dir=latex-papers/samizo-aitl-resume" >> "$GITHUB_OUTPUT"
          else
            echo "::error::main_resume.tex が見つかりません"
            exit 1
          fi
          echo "Using dir: ${{ steps.detect.outputs.dir }}"
          echo "Tree:"
          ls -la "${{ steps.detect.outputs.dir }}"

      # 4) 確実コンパイル（エラー時は直ちに失敗 & ログを表示）
      - name: Build with latexmk (LuaLaTeX)
        shell: bash
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          set -e
          # 一発で固めたいなら latexmk を使う
          latexmk -lualatex -halt-on-error -interaction=nonstopmode -file-line-error main_resume.tex
          # 念のため出来上がりを確認
          test -f main_resume.pdf
          echo "===== Generated files ====="
          ls -lh

      # 5) 失敗時のログをその場で出力（上の step が落ちたら自動実行）
      - name: Show log tail on failure
        if: failure()
        shell: bash
        run: |
          echo "==== tail main_resume.log ===="
          tail -n 200 "${{ steps.detect.outputs.dir }}/main_resume.log" || true

      # 6) PDF をアップロード（存在しなければ無視）
      - name: Upload PDF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main_resume_pdf
          path: |
            samizo-aitl-resume/main_resume.pdf
            latex-papers/samizo-aitl-resume/main_resume.pdf
          if-no-files-found: ignore

      # 7) ログ・中間ファイルも保存（追跡しやすくする）
      - name: Upload logs and intermediates
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latex_logs
          path: |
            ${{ steps.detect.outputs.dir }}/*.log
            ${{ steps.detect.outputs.dir }}/*.aux
            ${{ steps.detect.outputs.dir }}/*.fls
            ${{ steps.detect.outputs.dir }}/*.fdb_latexmk
            ${{ steps.detect.outputs.dir }}/*.synctex.gz
            ${{ steps.detect.outputs.dir }}/*.toc
            ${{ steps.detect.outputs.dir }}/*.out
          if-no-files-found: ignore
