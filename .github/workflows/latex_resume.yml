# .github/workflows/latex_resume.yml
name: Build Japanese LaTeX Resume

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Compile 職務経歴書 (LuaLaTeX)

    steps:
      # ① チェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # ② TeX Live full
      - name: Install TeX Live (full)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y texlive-full latexmk

      # ③ main_resume.tex の存在チェック
      - name: Detect resume directory
        id: detect
        run: |
          if [ -f "latex-papers/samizo-aitl-resume/main_resume.tex" ]; then
            echo "dir=latex-papers/samizo-aitl-resume" >> $GITHUB_ENV
          elif [ -f "samizo-aitl-resume/main_resume.tex" ]; then
            echo "dir=samizo-aitl-resume" >> $GITHUB_ENV
          elif [ -f "main_resume.tex" ]; then
            echo "dir=." >> $GITHUB_ENV
          else
            echo "::error::main_resume.tex が見つかりません"
            find . -type f | grep main_resume.tex || true
            exit 1
          fi
          echo "✅ Found TeX directory: $dir"
          ls -la $dir

      # ④ LuaLaTeXビルド
      - name: Build with LuaLaTeX
        run: |
          cd $dir
          echo "=== Building with LuaLaTeX ==="
          lualatex -interaction=nonstopmode -halt-on-error main_resume.tex
          lualatex -interaction=nonstopmode -halt-on-error main_resume.tex
          echo "=== Output files ==="
          ls -lh
        continue-on-error: false

      # ⑤ 失敗時のログ出力
      - name: Show log tail on failure
        if: failure()
        run: |
          echo "==== tail $dir/main_resume.log ===="
          tail -n 200 $dir/main_resume.log || true

      # ⑥ PDF アップロード
      - name: Upload PDF
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main_resume_pdf
          path: |
            $dir/main_resume.pdf
          if-no-files-found: ignore

      # ⑦ ログアップロード
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latex_logs
          path: |
            $dir/*.log
            $dir/*.aux
            $dir/*.fls
            $dir/*.fdb_latexmk
            $dir/*.synctex.gz
            $dir/*.toc
            $dir/*.out
          if-no-files-found: ignore
