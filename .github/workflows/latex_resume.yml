# .github/workflows/latex_resume.yml
name: Build Japanese LaTeX Resume

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Compile 職務経歴書 (LuaLaTeX)

    steps:
      # 1) 取得
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) TeX Live (full) をAPTで導入（HaranoAji/luatexja等を含む）
      - name: Install TeX Live (full)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y texlive-full latexmk

      # 3) どちらのパスに .tex があるか検出
      - name: Detect location
        id: detect
        shell: bash
        run: |
          if [ -f samizo-aitl-resume/main_resume.tex ]; then
            echo "dir=samizo-aitl-resume" >> "$GITHUB_OUTPUT"
          elif [ -f latex-papers/samizo-aitl-resume/main_resume.tex ]; then
            echo "dir=latex-papers/samizo-aitl-resume" >> "$GITHUB_OUTPUT"
          else
            echo "::error::main_resume.tex が見つかりません"
            exit 1
          fi
          echo "==> DIR is ${{ steps.detect.outputs.dir }}"

      # 4) LuaLaTeX でビルド（2回回して目次等も安定化）
      - name: Build with lualatex
        shell: bash
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          set -e
          lualatex -interaction=nonstopmode -halt-on-error main_resume.tex
          lualatex -interaction=nonstopmode -halt-on-error main_resume.tex
          # 参考: latexmk 版（必要なら切替）
          # latexmk -lualatex -interaction=nonstopmode -halt-on-error -pdf main_resume.tex
          ls -la

      # 5) PDF をアップロード
      - name: Upload PDF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main_resume_pdf
          path: |
            samizo-aitl-resume/main_resume.pdf
            latex-papers/samizo-aitl-resume/main_resume.pdf
          if-no-files-found: ignore

      # 6) ログ・中間ファイルを保存
      - name: Upload logs and intermediates
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latex_logs
          path: |
            samizo-aitl-resume/*.{log,aux,fls,fdb_latexmk,synctex.gz,toc,out}
            latex-papers/samizo-aitl-resume/*.{log,aux,fls,fdb_latexmk,synctex.gz,toc,out}
          if-no-files-found: ignore
