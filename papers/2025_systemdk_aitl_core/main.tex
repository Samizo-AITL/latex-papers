% ============================================================
% 2025 SystemDK with AITL Core 日本語版 (純粋工学理論稿) - Modular
% ============================================================

\documentclass[conference]{IEEEtran}

% ----------------------
% Core packages (order)
% ----------------------
\usepackage[T1]{fontenc}        % 欧文エンコーディング
\usepackage{CJKutf8}            % 日本語（CJK）

\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}
\usepackage{cite}

\usepackage{xcolor}             % ← color より xcolor 推奨（listings背景用）
\usepackage{listings}           % ソースコードは英数のみ
\usepackage{booktabs}
\usepackage{textcomp}
\usepackage{array}
\usepackage{tabularx}           % ← 表の可変幅
\newcolumntype{Y}{>{\raggedright\arraybackslash}X}
\newcolumntype{Z}{>{\centering\arraybackslash}X}

\usepackage{siunitx}
\sisetup{                        % ← detect-* の非推奨を回避
  mode = match,
  propagate-math-font = true,
  reset-math-version = false,
  reset-text-family  = false,
  reset-text-series  = false,
  reset-text-shape   = false,
  text-family-to-math = true,
  text-series-to-math = true,
  table-format = 3.2
}

\usepackage{microtype}          % はみ出し/アンダーフル緩和

% --- TikZ（図用） ---
\usepackage{tikz}
\usetikzlibrary{arrows.meta,positioning,shapes,fit,calc}

% --- algorithms（使う場合のみ） ---
\usepackage{algorithm}
\usepackage{algorithmic}

% ----------------------
% hyperref は最後に近い位置で
% ----------------------
\usepackage[hidelinks]{hyperref}

% ----------------------
% はみ出し対策（実用設定）
% ----------------------
\emergencystretch=3em
\frenchspacing
\def\UrlBreaks{\do\/\do-\do_\do.\do:\do?\do&}

% --- colors (listings背景で使用) ---
\usepackage{xcolor}
\definecolor{lightgray}{gray}{0.95}

% --- listings: 日本語は入れない（ASCII のみ） ---
\usepackage{listings}

% ← postbreak で使う安全なマクロ（カンマ等を含めない）
\newcommand{\ListingPostbreak}{\textcolor{gray}{\ensuremath{\hookrightarrow}}\ }

% ---- IEEE 2段用タイトスタイル（安全版）----
\lstdefinestyle{ieee-tight}{
  columns=fullflexible,
  keepspaces=true,
  breaklines=true,
  breakatwhitespace=false,
  basicstyle=\ttfamily\scriptsize,
  frame=single,
  backgroundcolor=\color{lightgray},
  % 枠内余白（詰め気味）
  framexleftmargin=0.6ex,
  framexrightmargin=0.6ex,
  framextopmargin=0.4ex,
  framexbottommargin=0.4ex,
  % 行幅は常に段幅
  linewidth=\linewidth,
  xleftmargin=0pt,
  xrightmargin=0pt,
  % 行番号（必要なら）
  numbers=left,
  numberstyle=\tiny,
  numbersep=4pt,
  % キャプションを下に（見出し重なり防止）
  captionpos=b,
  % 周囲の上下間隔（見出し衝突回避）
  aboveskip=0.5\baselineskip,
  belowskip=0.6\baselineskip,
  % 折り返し記号（安全なマクロを使用）
  postbreak=\mbox{\ListingPostbreak}
}

% --- 既定の \lstset（最小限・安全）
\lstset{
  style=ieee-tight,
  inputencoding=ascii,
  extendedchars=false
}

% --- JSON 言語定義（1個だけに統一） ---
\lstdefinelanguage{json}{
  basicstyle=\ttfamily\scriptsize,
  showstringspaces=false,
  breaklines=true,
  breakatwhitespace=false,
  frame=single,
  morestring=[b]",
  stringstyle=\color{black},
  numbers=left, numberstyle=\tiny, numbersep=4pt,
  literate=
   *{0}{{0}}1 {1}{{1}}1 {2}{{2}}1 {3}{{3}}1 {4}{{4}}1
    {5}{{5}}1 {6}{{6}}1 {7}{{7}}1 {8}{{8}}1 {9}{{9}}1
    {:}{{:}}1 {,}{{,}}1 {\{}{{\{}}1 {\}}{{\}}}1 {[}{{[}}1 {]}{{]}}1
}

% URL 自動改行を更に強化（任意：効果大）
\usepackage{xurl}

% ----------------------
% タイトル・著者
% ----------------------
\title{SystemDK with AITL Core：設計・信頼性・制御を統合する自律的アーキテクチャ}

\author{%
  \IEEEauthorblockN{三溝 真一 (Shinichi Samizo)}%
  \IEEEauthorblockA{独立系半導体研究者（元セイコーエプソン） / Independent Semiconductor Researcher (ex-Seiko Epson)\\%
  Email: \href{mailto:shin3t72@gmail.com}{shin3t72@gmail.com}\quad
  GitHub: \url{https://github.com/Samizo-AITL}}%
}

\begin{document}

% ===== CJK開始：IPAex 明朝(ipxm) =====
%   ※ 日本語は CJK 環境内、欧文は通常のままでOK
\begin{CJK}{UTF8}{ipxm}

\maketitle

% --- abstract & keywords ---
\input{chap0_abstract}

% --- chapters ---
\input{chap1_intro}
\input{chap2_systemdk}
\input{chap3_aitl}
\input{chap4_flow}        % ← 日本語や矢印は listings に入れないこと
\input{chap5_reliability}
\input{chap6_discussion}
\input{chap7_conclusion}

% --- appendix ---
\input{appendix}

% --- references（使うときだけ有効化） ---
% \bibliographystyle{IEEEtran}
% \bibliography{references}

% --- biography ---
\input{biography}

\end{CJK}
\end{document}
